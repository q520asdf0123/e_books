package com.tiny.hero.plat.module.account;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.JSONObject;
import com.tiny.hero.plat.common.constant.GameError;
import com.tiny.hero.plat.common.constant.GmOpType;
import com.tiny.hero.plat.common.domain.ResponseDTO;
import com.tiny.hero.plat.module.account.domain.entity.PayInfo;
import com.tiny.hero.plat.module.account.domain.vo.BindVo;
import com.tiny.hero.plat.module.account.domain.vo.LoginVo;
import com.tiny.hero.plat.module.account.domain.vo.VerifyVo;
import com.tiny.hero.plat.module.message.Handler;
import com.tiny.hero.plat.module.message.pool.MessagePool;
import com.tiny.hero.plat.module.server.ServerCache;
import com.tiny.hero.plat.util.DuokeHttpUtil;
import com.tiny.hero.plat.util.DuokeIPUtil;
import com.tiny.hero.plat.util.HttpPacket;
import com.google.api.client.googleapis.auth.oauth2.GoogleCredential;
import com.google.api.client.googleapis.auth.oauth2.GoogleIdToken;
import com.google.api.client.googleapis.auth.oauth2.GoogleIdTokenVerifier;
import com.google.api.client.googleapis.javanet.GoogleNetHttpTransport;
import com.google.api.client.http.HttpTransport;
import com.google.api.client.http.apache.ApacheHttpTransport;
import com.google.api.client.json.jackson2.JacksonFactory;
import com.google.api.services.androidpublisher.AndroidPublisher;
import com.google.api.services.androidpublisher.AndroidPublisherScopes;
import com.google.api.services.androidpublisher.model.ProductPurchase;
import com.tiny.hero.plat.module.account.domain.dto.BindDto;
import com.tiny.hero.plat.module.account.domain.dto.DeleteDto;
import com.tiny.hero.plat.module.account.domain.dto.LoginDto;
import com.tiny.hero.plat.module.account.domain.dto.VerifyDto;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.io.ClassPathResource;
import org.springframework.core.io.DefaultResourceLoader;
import org.springframework.core.io.Resource;
import org.springframework.core.io.ResourceLoader;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

@Slf4j
@RestController
public class AccountController {

    @Autowired
    AccountService accountService;
    @Autowired
    private ServerCache serverCache;

    @PostMapping("/account/login")
    public ResponseDTO<LoginVo> login(@RequestBody LoginDto req) {
        HttpServletRequest request =
                ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
        String ip = DuokeIPUtil.getRemoteIp(request);
        req.setIp(ip);

        return accountService.login(req);
    }

    @PostMapping("/account/verify")
    public ResponseDTO<VerifyVo> verify(@RequestBody VerifyDto req) {
        return accountService.verify(req);
    }

    /**
     * 绑定账号
     *
     * @param req
     * @return
     */
    @PostMapping("/account/bind")
    public ResponseDTO<BindVo> bind(@RequestBody BindDto req) {
        return accountService.bind(req);
    }

    @PostMapping("/account/delete")
    public ResponseDTO delete(@RequestBody DeleteDto req) {
        return accountService.delete(req);
    }

    @PostMapping("/account/codeLogin")
    public ResponseDTO<LoginVo> codeLogin(@RequestBody LoginDto req) {
        HttpServletRequest request =
                ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();
        String ip = DuokeIPUtil.getRemoteIp(request);
        req.setIp(ip);

        return accountService.codeLogin(req);

    }

    @RequestMapping("/account/payBackHaiTunQuick")
    public String payBack(HttpServletRequest request) {
        return accountService.payBack(request, "haitun");
    }

    @RequestMapping("/account/payBackHaiTunQuick2")
    public String payBackHaiTun2(HttpServletRequest request) {
        return accountService.payBack(request, "haitun2");
    }

    @RequestMapping("/account/payBackGameCaff")
    public String payBackGameCaff(HttpServletRequest request) {
        return accountService.payBack(request, "gamecaff");
    }

    @RequestMapping("/account/payBackGameCaff2")
    public String payBackGameCaff2(HttpServletRequest request) {
        return accountService.payBack(request, "gamecaff2");
    }

    @RequestMapping("/account/payBackNewGameCaff")
    public String payBackNewGameCaff(HttpServletRequest request) {
        return accountService.payBack(request, "gamecaff2");
    }

    @RequestMapping("/account/payBackGameCaffCN")
    public String payBackGameCaffCN(HttpServletRequest request) {
        return accountService.payBack(request, "gamecaff_cn");
    }

    @RequestMapping("/account/payBackGameCaffKR")
    public String payBackGameCaffKR(HttpServletRequest request) {
        return accountService.payBack(request, "gamecaff_kr");
    }

    @RequestMapping("/account/payBackTinynetIos")
    public String payBackTinynetIos(HttpServletRequest request) {
        return accountService.payBack(request, "tinynet_ios");
    }

    @PostMapping("/account/payBackTinynetGoogle")
    public String payBackTinynetGoogle(HttpServletRequest request) {
        return accountService.payBack(request, "tinynet_and");
    }

    @PostMapping("/account/payBackBanhao")
    public String payBackBanhao(HttpServletRequest request) {
        return accountService.payBack(request, "tinynet_banhao");
    }

    @Data
    public static class Test {
        private String packageName;
        private String productId;
        private String purchaseToken;
    }

    @PostMapping("/testGoogle")
    public String testGoogle(@RequestBody Test test) {

        try {
            log.info("test info:{}", test);
            List<String> scopes = new ArrayList<>();
            scopes.add(AndroidPublisherScopes.ANDROIDPUBLISHER);
            ResourceLoader resourceLoader = new DefaultResourceLoader();
            Resource resource = new ClassPathResource("com/tiny/hero/plat/module/account/plat/google/" + "hero.json");
            GoogleCredential credential = GoogleCredential.fromStream(resource.getInputStream()).createScoped(scopes);
            // 使用谷歌凭据和收据从谷歌获取购买信息
            HttpTransport httpTransport = GoogleNetHttpTransport.newTrustedTransport();
            JacksonFactory jsonFactory = new JacksonFactory();
            AndroidPublisher publisher =
                    new AndroidPublisher.Builder(httpTransport, jsonFactory, credential).setApplicationName("hero").build();
            AndroidPublisher.Purchases purchases = publisher.purchases();
            final AndroidPublisher.Purchases.Products.Get request =
                    purchases.products().get(test.getPackageName(), test.getProductId(), test.getPurchaseToken());

            ProductPurchase execute = request.execute();
            log.info("===========>:{}", execute);
        } catch (Exception e) {
            e.printStackTrace();
        }

        return "ok;";
    }

    @GetMapping("/testGoogleLogin")
    public String testGoogle() {

        try {
            ApacheHttpTransport transport = new ApacheHttpTransport();
            JacksonFactory jsonFactory = new JacksonFactory();
            GoogleIdTokenVerifier verifier =
                    new GoogleIdTokenVerifier.Builder(transport, jsonFactory)
                            .setAudience(Collections
                                    .singletonList("651222524053-4fkqosf6hmcko67rr3uoole2ffan627j.apps.googleusercontent.com"))
                            .build();
            String identityToken =
                    "eyJhbGciOiJSUzI1NiIsImtpZCI6IjU5NjJlN2EwNTljN2Y1YzBjMGQ1NmNiYWQ1MWZlNjRjZWVjYTY3YzYiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL2FjY291bnRzLmdvb2dsZS5jb20iLCJhenAiOiI2NTEyMjI1MjQwNTMtOTNuZWg3ZTFqZThtMWw1NmljOWM0Z21yb2dnZWZrcTAuYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJhdWQiOiI2NTEyMjI1MjQwNTMtNGZrcW9zZjZobWNrbzY3cnIzdW9vbGUyZmZhbjYyN2ouYXBwcy5nb29nbGV1c2VyY29udGVudC5jb20iLCJzdWIiOiIxMTY3MDUxOTAyMDg2ODAxMzQwMzQiLCJlbWFpbCI6Impvc2VwaGppZTU4ODMxQGdtYWlsLmNvbSIsImVtYWlsX3ZlcmlmaWVkIjp0cnVlLCJuYW1lIjoiT25nIFNpYW4gSmllIiwicGljdHVyZSI6Imh0dHBzOi8vbGgzLmdvb2dsZXVzZXJjb250ZW50LmNvbS9hL0FFZEZUcDRwdFFhUHo0RDg4cmgtSGhpV3B4SksxRUMxRXgtM3dGXzY5VFIxPXM5Ni1jIiwiZ2l2ZW5fbmFtZSI6Ik9uZyIsImZhbWlseV9uYW1lIjoiU2lhbiBKaWUiLCJsb2NhbGUiOiJlbiIsImlhdCI6MTY3Njc5MzU2MiwiZXhwIjoxNjc2Nzk3MTYyfQ.bST5ZLpWJay_BjysWGbQCL-7Z_gvfgPpiwBFAZx6JgLy6viDhu6BTcWE68uxWZVPt8g7tCeDY2BKFWA6FOSeQZ4BM5PcCURUmq4pXyGkpcY1itOEswLeIHlany2UNtLDuO6QeLHlGyFtdSk57OyUrG5VeQOHd-rING8znaCtyPechXuvw8bTxAOxmgnMOjQHvfPV2rBQDgz3HTpg5dSerchHOSMHh3YWqoKTFH2z3UsunsrJ0om2WsfuZCHsnt4lw4E3CkGJ0BSTdP-6hOl8JPiKxkIOWrrA4uosLUd-oUGV7FfpHriom7fEe2mWoa2jUX6Szd8NEbRpyjUXiDahbQ";
            try {
                GoogleIdToken verify = verifier.verify(identityToken);
                log.info("token:{}", verify);
                GoogleIdToken.Payload payload = verify.getPayload();
                String subject = payload.getSubject();
                log.info("subject:{}", subject);
            } catch (Exception e) {
                log.error("登录错误:{}", e.getMessage(), e);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }

        return "ok;";
    }

    @RequestMapping("/account/gmTools.do") // 后台的所有请求都走到这边来
    public String gmTools(@RequestBody HttpPacket packet) {
        log.info("后台发送的消息:" + packet.toString());
        JSONObject data = packet.getData();
        String type = (String) data.get("type");

        if (StringUtils.isBlank(type)) {
            throw new NullPointerException();
        }

        switch (type) {
            case GmOpType.BU_DAN:
            case GmOpType.SYS_RECHARGE:
                PayInfo payInfo = new PayInfo();
                String channelId = (String) data.get("channelId");
                String orderId = (String) data.get("orderId");
                payInfo.setChannelId(channelId);
                payInfo.setOrderId(orderId);
                return accountService.buDan(payInfo);
            // case GmOpType.Silence:
            // case GmOpType.Forbid:
            // case GmOpType.GetPayAct:
            // case GmOpType.QueryChat:
            // case GmOpType.ServerKeep:
            // case GmOpType.ReloadAct:
            // case GmOpType.ReloadItem:
            // int serverId = data.getInteger("serverId");
            // String url = serverCache.getServer(serverId).getHttpAddress();
            // return DuokeHttpUtil.sentPost(url, JSON.toJSONString(packet));
            default:
                int serverId = data.getInteger("serverId");
                String url = serverCache.getServer(serverId).getHttpAddress();
                return DuokeHttpUtil.sentPost(url, JSON.toJSONString(packet));
            // throw new NullPointerException("未到找到发送类型:" + type);

        }
    }

    @PostMapping("/account/inner.do")
    public String inner(HttpServletRequest request, @RequestBody HttpPacket packet) {
        log.info("游服发送的消息:" + packet.toString());
        GameError gameError = GameError.SUCCESS;
        try {
            Handler handler = MessagePool.getIns().getHander(packet.getCmdId());
            gameError = handler.handle(packet);
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }
        return String.valueOf(gameError.getCode());
    }

}
